kernel:
  image: linuxkit/kernel:4.14.90
  cmdline: "console=tty0 console=ttyS0 console=ttyAMA0 console=ttysclp0"
init:
  - linuxkit/init:b2066f277482d02b8232c7b8520d52a66a7940c3
  - linuxkit/runc:83d0edb4552b1a5df1f0976f05f442829eac38fe
  - linuxkit/containerd:326b096cd5fbab0f864e52721d036cade67599d6
  - linuxkit/ca-certificates:v0.6
onboot:
  - name: metadata
    image: linuxkit/metadata:v0.6
  - name: sysctl
    image: linuxkit/sysctl:v0.6
  - name: sysfs
    image: linuxkit/sysfs:v0.6
  - name: format
    image: linuxkit/format:v0.6
  - name: mount
    image: linuxkit/mount:v0.6
    # TODO: need something more sophisticated here, especially when we decide on storage
    capabilities: [CAP_SYS_ADMIN, CAP_CHOWN]
    command:
      - sh
      - -c
      - >
        mountie /var/lib/homebox ;
        mkdir -p /var/lib/homebox/.pms ;
        mkdir -p /var/lib/homebox/.pms/data ;
        mkdir -p /var/lib/homebox/.pms/config ;
        mkdir -p /var/lib/homebox/.transmission ;
        mkdir -p /var/lib/homebox/.transmission/config ;
        mkdir -p /var/lib/homebox/Downloads ;
        mkdir -p /var/lib/homebox/Dropbox ;
        mkdir -p /var/lib/homebox/Dropbox/.dropbox.cache ;
        mkdir -p /var/lib/homebox/Dropbox/.dropbox.cache/attrs_cache ;
        mkdir -p /var/lib/homebox/Dropbox/.dropbox.cache/placeholder_cache ;
        mkdir -p /var/lib/homebox/Dropbox/.dropbox.cache/prefetch_cache ;
        chown 1000:100 -R /var/lib/homebox ;
services:
  - name: getty
    image: linuxkit/getty:2eb742cd7a68e14cf50577c02f30147bc406e478
    env:
     - INSECURE=true
  - name: rngd
    image: linuxkit/rngd:v0.6
  - name: dhcpcd
    image: linuxkit/dhcpcd:v0.6
  - name: ntpd
    image: linuxkit/openntpd:v0.6
  - name: pms
    # https://hub.docker.com/r/plexinc/pms-docker/tags
    image: plexinc/pms-docker:1.14.1.5488-cc260c476
    capabilities: [all] # TODO: refine this
    # TODO: move it to bridged network
    net: host
    runtime:
      envFromFile:
        TZ: "/run/config/pms/timezone"
        PLEX_CLAIM: "/run/config/pms/plex_claim"
    binds:
      - /etc/resolv.conf:/etc/resolv.conf
      # /config has the actual index of the libraries etc
      - /var/lib/homebox/.pms/config:/config
      # /data has misc data and the media library
      - /var/lib/homebox/.pms/data:/data
      - /var/lib/homebox/Downloads:/data/Downloads
      - /var/lib/homebox/Dropbox:/data/Dropbox
    # /transcode can be mounted at tempfs, as keeping it
    # inside the container maybe not be so wise
    # TODO: identify long-term solution
    tmpfs: [/transcode]
    env:
      - PLEX_UID=1000
      - PLEX_GID=100
      - CHANGE_CONFIG_DIR_OWNERSHIP=false
      #- ALLOWED_NETWORKS=192.168.1.0/24,172.16.0.0/16
      - PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
  - name: dbx
    image: errordeveloper/dropbox:af6954a9cf00054da9dbfbb3a7b4ca907a239940
  - name: transmission
    image: errordeveloper/transmission:6475355f5e483b47484b3916e41b8f47d41be0fa
    binds:
      # we will move this to metadata or the container image later
      - /var/lib/homebox/.transmission/config:/home/transmission/.config/transmission-daemon
files:
  - path: var/lib/homebox
    directory: true
trust:
  org:
    - linuxkit
    - library
